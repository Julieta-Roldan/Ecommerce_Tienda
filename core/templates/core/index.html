{% extends 'base.html' %}
{% load static %}

{% block content %}
{% load humanize %} 

<section class="hero">
    <div class="hero-content">
        <h1>TIENDA LORE</h1>
        <p>NUEVA TEMPORADA 2026</p>
      <a href="{% url 'catalogo' %}" class="btn-luxury">VER CATÁLOGO</a>
    </div>
</section>

<div id="categorias" class="container mt-5 mb-5">
    <div class="row g-3">
    
        <div class="col-6 col-md-3">
           <a href="{% url 'catalogo_categoria' 'Pantalones' %}">
                <div class="category-card" style="background-image: url('https://acdn-us.mitiendanube.com/stores/001/039/300/products/_dsc0208nkjnb-8204fa31ada5a1173e17471627902197-1024-1024.webp');">
                    <div class="category-content">Pantalones</div>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
           <a href="{% url 'catalogo_categoria' 'Remeras' %}">
                <div class="category-card" style="background-image: url('https://acdn-us.mitiendanube.com/stores/001/039/300/products/_dsc0097-f81bb954ff3e7495a717570073424739-1024-1024.webp');">
                    <div class="category-content">Remeras</div>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
          <a href="{% url 'catalogo_categoria' 'Vestidos' %}">
                <div class="category-card" style="background-image: url('https://miaminovias.com/cdn/shop/files/GL3558_CHAMPAGNE_1O.jpg?v=1737356845&width=600');">
                    <div class="category-content">Vestidos</div>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-3">
          <a href="{% url 'catalogo_categoria' 'Accesorios' %}">
                <div class="category-card" style="background-image: url('https://goldgirlsdiary.wordpress.com/wp-content/uploads/2020/08/f09d9192f09d9382f09d9382f09d92b6-40f09d9388f09d92b6f09d9388f09d9388f09d938ef09d92b8f09d92bdf09d919cf09d919c-shared-by-f09d9192f09d9382f09d9382f09d92b6-on-we-heart-it.jpg');">
                    <div class="category-content">Accesorios</div>
                </div>
            </a>
        </div>

    </div>
</div>
<section class="benefits-section py-5">
    <div class="container">
        <div class="row text-center g-4">
            
            <div class="col-md-4">
                <div class="benefit-item">
                    <i class="bi bi-credit-card benefit-icon"></i>
                    <h3>3 y 6 cuotas sin interés!</h3>
                </div>
            </div>

            <div class="col-md-4">
                <div class="benefit-item">
                    <i class="bi bi-percent benefit-icon"></i>
                    <h3>20% de descuento con transferencia</h3>
                </div>
            </div>

            <div class="col-md-4">
                <div class="benefit-item">
                    <i class="bi bi-arrow-repeat benefit-icon"></i>
                    <h3>Cambios y devoluciones</h3>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="featured-products py-5">
    <div class="container">
       <center><h2 class="section-title text-center mb-5">PRODUCTOS DESTACADOS</h2></center> 
        
        <div class="row g-4">
            {% for prod in productos %}
            <div class="col-6 col-md-3">
                <div class="product-card d-flex flex-column h-100 position-relative">
                    <div class="product-image position-relative">
                        <span class="badge-new" style="left: 10px; top: 10px;">NUEVO</span>
                        
                        <button class="btn-favorito position-absolute border-0 bg-transparent" 
                                data-id="{{ prod.id }}" 
                                data-nombre="{{ prod.nombre }}" 
                                data-precio="{{ prod.precio }}" 
                                data-imagen="{% if prod.imagenes.all %}{{ prod.imagenes.first.imagen.url }}{% endif %}"
                                style="right: 10px; top: 10px; z-index: 10; color: #000000; cursor: pointer;">
                            <i class="bi bi-heart" style="font-size: 1.4rem;"></i>
                        </button>

                        <a href="{% url 'producto_detalle' prod.id %}">
                            {% if prod.imagenes.all %}
                                <img src="{{ prod.imagenes.first.imagen.url }}" alt="{{ prod.nombre }}" style="height: 350px; width: 100%; object-fit: cover;">
                            {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center" style="height: 350px;">
                                    <span class="text-muted">Sin foto</span>
                                </div>
                            {% endif %}
                        </a>
                    </div>
                    
                    <div class="product-info text-center d-flex flex-column flex-grow-1 mt-2">
                        <h3 class="product-name text-uppercase" style="min-height: 40px; font-size: 0.9rem;">{{ prod.nombre }}</h3>
                      <p class="product-price fw-bold mb-1">$ {{ prod.precio|floatformat:0|intcomma }}</p>
                      <p class="product-installments small text-muted">3 cuotas de <strong>$ {{ prod.cuota|floatformat:0|intcomma }}</strong></p>

                        
                        <button class="btn-add-cart mt-auto" data-id="{{ prod.id }}">AGREGAR AL CARRITO</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function actualizarBotones() {
        // UNIFICADO: Usamos 'mis_favoritos' para que coincida con favoritos.html
        let favoritos = JSON.parse(localStorage.getItem('mis_favoritos')) || [];
        
        document.querySelectorAll('.btn-favorito').forEach(btn => {
            const prodId = btn.getAttribute('data-id');
            const icon = btn.querySelector('i');
            
            if (favoritos.some(p => p.id === prodId)) {
                icon.classList.replace('bi-heart', 'bi-heart-fill');
                btn.style.color = 'red';
            } else {
                icon.classList.replace('bi-heart-fill', 'bi-heart');
                btn.style.color = 'black';
            }
        });
    }

    actualizarBotones();

    document.querySelectorAll('.btn-favorito').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const prodData = {
                id: this.getAttribute('data-id'),
                nombre: this.getAttribute('data-nombre'),
                // Guardamos el precio como número redondo
                precio: Math.round(parseFloat(this.getAttribute('data-precio'))),
                imagen: this.getAttribute('data-imagen')
            };

            let favs = JSON.parse(localStorage.getItem('mis_favoritos')) || [];
            const index = favs.findIndex(p => p.id === prodData.id);

            if (index === -1) {
                favs.push(prodData);
            } else {
                favs.splice(index, 1);
            }

            localStorage.setItem('mis_favoritos', JSON.stringify(favs));
            actualizarBotones();
        });
    });
});

</script>

<script>
document.querySelectorAll('.btn-add-cart').forEach(boton => {
    boton.addEventListener('click', function(e) {
        e.preventDefault();
        const productoId = this.getAttribute('data-id');
        const url = `/carrito/agregar/${productoId}/`; //const url = carrito/agregar/${productoId}/;

        // Cambiamos el texto inmediatamente para dar feedback
        const textoOriginal = this.innerText;
        this.innerText = "PROCESANDO...";
        this.disabled = true;

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Error en la red');
            return response.json();
        })
        .then(data => {
            // Feedback visual de éxito
            this.innerText = "¡AGREGADO!";
            this.style.backgroundColor = "#28a745"; // Verde éxito
            this.style.color = "white";

            // Hacemos que el icono del carrito en el navbar resalte
            const cartIcon = document.querySelector('.bi-bag');
            if(cartIcon) {
                cartIcon.style.transform = 'scale(1.3)';
                cartIcon.style.color = 'red';
                setTimeout(() => {
                    cartIcon.style.transform = 'scale(1)';
                    cartIcon.style.color = '';
                }, 1000);
            }

            setTimeout(() => {
                this.innerText = textoOriginal;
                this.style.backgroundColor = "";
                this.style.color = "";
                this.disabled = false;
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            this.innerText = "ERROR";
            this.style.backgroundColor = "red";
            setTimeout(() => {
                this.innerText = textoOriginal;
                this.style.backgroundColor = "";
                this.disabled = false;
            }, 2000);
        });
    });
});
</script>
{% endblock %}